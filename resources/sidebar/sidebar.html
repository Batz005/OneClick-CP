<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{styleUri}}" />
    <title>OneClick CP</title>
    </head>
    <body class="{{themeClass}}">
    <div class="sidebar-header">
        <img src="{{logoUri}}" class="logo" alt="OneClick CP Logo" />
        <h2>OneClick CP</h2>
        <p class="subtitle">Your one-click DSA & CP starter kit</p>
    </div>
    <div class="sidebar-container">
      <div class="sidebar-wrapper">

        <!-- ===================== -->
        <!-- Template Section      -->
        <!-- ===================== -->
        <section class="section-template">
            <h2>Templates</h2>
            <label for="templatePicker" class="template-label">Choose Template:</label>
            <div class="template-picker-row">
                <select id="templatePicker">
                    <option value="default">Default Template</option>
                    <option value="Fast_IO">Fast IO</option>
                    <option value="Debug_Template">Debug Template</option>
                    <option value="CP_Template">CP Template</option>
                </select>
                <button
                    id="deleteTemplateBtn"
                    class="delete-btn"
                    onclick="deleteTemplate()"
                    aria-label="Delete Template"
                    title="Delete selected template (only for custom templates)"
                >üóëÔ∏è</button>
            </div>

            <div class="button-row">
                <button class="reset-btn" onclick="resetFiles()" title="Reset files using selected template">
                    üîÑ Reset Files
                </button>
                <button onclick="vscode.postMessage({ command: 'exportSolution' })" title="Export solution to folder">
                    üì§ Export Solution
                </button>
            </div>

            <div class="button-row">
                <button onclick="vscode.postMessage({ command: 'resetAndExportSolution', template: selectedTemplate })" title="Export and reset">
                    üì§ Export + üîÑ Reset
                </button>
            </div>

            <div class="button-row">
                <button onclick="openSaveTemplateDialog()" title="Save current files as a new template">
                    ‚ûï Create Custom Template
                </button>
            </div>
        </section>

        <!-- ===================== -->
        <!-- Snippet Section       -->
        <!-- ===================== -->
        <section class="section-snippets">
            <h2>Snippets</h2>

            <div class="snippet-options">
                <label>
                    <input type="checkbox" id="showPreview" checked />
                    Snippet Preview
                </label>
                <small style="color: var(--vscode-descriptionForeground); font-style: italic;">
                    Snippet hover shows editor & tooltip preview (editor preview may be inaccurate).
                </small>
                <pre id="snippetTooltip" class="snippet-tooltip"></pre>
                <div class="language-select-wrapper">
                  <label for="languagePicker">Language:</label>
                  <select id="languagePicker" onchange="onSnippetLanguageSelected()">
                      <option value="cpp">C++</option>
                      <option value="python">Python</option>
                      <option value="java">Java</option>
                  </select>
                </div>
                <button class="create-snippet-btn" onclick="startCreateSnippet()" title="Create a custom snippet from editor selection">
                  ‚ûï Create Snippet from Selection
                </button>
    <!-- Create Snippet Dialog -->
    <dialog id="createSnippetDialog">
      <form method="dialog" id="createSnippetForm" class="dialog-form">
        <h4>Create Custom Snippet</h4>
        <p class="dialog-info">Review the code below, then name and categorize your snippet.</p>

        <div class="grid-two">
          <label>Language
            <select id="snipLang">
              <option value="cpp">C++</option>
              <option value="python">Python</option>
              <option value="java">Java</option>
            </select>
          </label>
          <label>Subcategory
            <input type="text" id="snipSubcat" placeholder="e.g., basics" />
          </label>
        </div>

        <div class="grid-two">
          <label>Name / Key
            <input type="text" id="snipName" placeholder="unique_key" required />
          </label>
          <label>Prefix (typed to trigger)
            <input type="text" id="snipPrefix" placeholder="cpmySnippet" />
          </label>
        </div>

        <label>Description
          <input type="text" id="snipDesc" placeholder="What this snippet does‚Ä¶" />
        </label>

        <label>Snippet Body (editable)
          <textarea id="snipBody" rows="10" spellcheck="false"></textarea>
        </label>

        <div class="dialog-actions">
          <button type="button" onclick="refreshSelectionForSnippet()">Use Current Selection</button>
          <span class="spacer"></span>
          <button type="button" onclick="confirmCreateSnippet()">Save</button>
          <button type="button" onclick="cancelCreateSnippet()">Cancel</button>
        </div>
      </form>
    </dialog>
            </div>

            <div class="snippet-accordion">
                <button class="accordion">Snippets</button>
                <div class="panel snippetSelection">

                    <!-- Data Structures -->
                    <div class="data_structures">
                        <button class="accordion" value="data_structures">Data Structures</button>
                        <div class="dsPanel panel"></div>
                    </div>

                    <!-- Algorithms -->
                    <div class="algorithms">
                        <button class="accordion" value="algorithms">Algorithms</button>
                        <div class="algoPanel panel"></div>
                    </div>

                    <!-- Miscellaneous -->
                    <div class="misc">
                        <button class="accordion" value="misc">Miscellaneous</button>
                        <div class="miscPanel panel"></div>
                    </div>

                    <!-- Custom -->
                    <div class="custom">
                        <button class="accordion" value="custom">Custom</button>
                        <div class="customPanel panel"></div>
                    </div>

                </div>
            </div>
        </section>

        <!-- ===================== -->
        <!-- Arrange Layout Button -->
        <!-- ===================== -->
        <section class="section-view">
            <button
                class="arrange-btn"
                title="Arrange files in columns"
                onclick="vscode.postMessage({ command: 'arrangeLayout' })"
            >üß© Arrange View</button>
        </section>

        <p class="coming-soon">üî• More features coming soon...</p>
      </div>
      <footer class="signature">
          <img src="{{bkLogoUri}}" class="bk-logo" alt="Bharath Kotipalli Logo" />
          <p>Created by Bharath Kotipalli</p>
      </footer>
    </div>

    <!-- Save Template Dialog -->
    <dialog id="saveTemplateDialog">
      <form method="dialog" id="saveTemplateForm">
        <h4>Create Custom Template</h4>
        <p class="dialog-info">
            Only checked files will be saved. Content is taken from open files in your workspace.
        </p>
        <div>
          <label><input type="checkbox" id="includeMainCpp" checked /> main.cpp</label><br>
          <label><input type="checkbox" id="includeInputTxt" checked /> input.txt</label><br>
          <label><input type="checkbox" id="includeOutputTxt" checked /> output.txt</label>
        </div>
        <div>
          <label for="templateName">Template Name:</label>
          <input type="text" id="templateName" required />
        </div>
        <div>
          <button type="button" onclick="saveTemplate()">Save</button>
          <button type="button" onclick="closeSaveTemplateDialog()">Cancel</button>
        </div>
      </form>
    </dialog>

    <!-- Confirm Delete Dialog -->
    <dialog id="deleteConfirmDialog">
    <form method="dialog">
        <p id="deleteConfirmText"></p>
        <button value="yes" id="deleteYesBtn">Delete</button>
        <button value="no">Cancel</button>
    </form>
    </dialog>

    <script>
        const vscode = acquireVsCodeApi();
        let selectedTemplate = 'default';

        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("accordion")) {
                e.target.classList.toggle("active");
                const panel = e.target.nextElementSibling;
                if (panel && panel.classList.contains("panel")) {
                    panel.style.display = panel.style.display === "flex" ? "none" : "flex";
                }
                e.target.setAttribute('aria-expanded', String(panel.style.display === 'none'));
                panel.setAttribute('aria-hidden', String(panel.style.display !== 'flex'));
            }
        });
        document.getElementById('templatePicker').addEventListener('change', (e) => {
            selectedTemplate = e.target.value;
            updateDeleteButton();
        });

        function collapseAllAccordions() {
          document.querySelectorAll('.accordion').forEach(acc => {
            const panel = acc.nextElementSibling;
            acc.classList.remove('active');
            acc.setAttribute('aria-expanded', 'false');
            if (panel && panel.classList.contains("panel")) {
              panel.style.display = "none";
              panel.setAttribute('aria-hidden', 'true');
            }
          });
        }

        function expandAccordionCategory(target) {
            // Always open the top-level "Snippets" accordion
            const topAcc = document.querySelector('.snippet-accordion > .accordion');
            const topPanel = topAcc && topAcc.nextElementSibling;
            if (topAcc && topPanel && topPanel.classList.contains('panel')) {
                topAcc.classList.add('active');
                topPanel.style.display = 'flex';
                topPanel.setAttribute('aria-hidden', 'false');
                topAcc.setAttribute('aria-expanded', 'true');
            }

            document.querySelectorAll('.accordion').forEach(acc => {
            const cat = acc.getAttribute('data-category');
            const sub = acc.getAttribute('data-subcategory');
            const panel = acc.nextElementSibling;
            const isMatch = (cat === target || sub === target);

            if (panel && panel.classList.contains('panel')) {
                if (isMatch) {
                acc.classList.add('active');
                panel.style.display = 'flex';
                panel.setAttribute('aria-hidden', 'false');
                acc.setAttribute('aria-expanded', 'true');
                } else if (cat || sub) {
                // Only collapse snippet sub-accordions; leave unrelated top-level alone
                acc.classList.remove('active');
                panel.style.display = 'none';
                panel.setAttribute('aria-hidden', 'true');
                acc.setAttribute('aria-expanded', 'false');
                }
            }
            });
        }
        function deleteTemplate() {
            const picker = document.getElementById('templatePicker');
            const selectedTemplate = picker.value;
            if (
                selectedTemplate === 'default' ||
                selectedTemplate === 'Fast_IO' ||
                selectedTemplate === 'Debug_Template' ||
                selectedTemplate === 'CP_Template'
            ) {
                alert("Cannot delete default/built-in templates.");
                return;
            }
            
            // Show custom dialog
            const dialog = document.getElementById('deleteConfirmDialog');
            document.getElementById('deleteConfirmText').textContent =
                `Delete template "${selectedTemplate}"?`;
            dialog.showModal();

            dialog.addEventListener('close', function handler() {
                if (dialog.returnValue === 'yes') {
                    vscode.postMessage({
                        command: 'deleteTemplate',
                        templateName: selectedTemplate
                    });
                }
                dialog.removeEventListener('close', handler);
            });
        }

        function resetFiles() {
            vscode.postMessage({ command: 'resetFiles', template: selectedTemplate });
        }

        // Dialog logic
        const dialog = document.getElementById('saveTemplateDialog');
        function openSaveTemplateDialog() {
            dialog.showModal();
        }
        function closeSaveTemplateDialog() {
            dialog.close();
        }

        // ---- Custom Snippet Creation Flow ----
        const createSnippetDialog = document.getElementById('createSnippetDialog');

        function startCreateSnippet() {
          const requestedLang = document.getElementById('languagePicker').value;
          vscode.postMessage({ command: 'prepareCreateSnippet', requestedLang });
        }

        function refreshSelectionForSnippet() {
          vscode.postMessage({ command: 'getSelectionText' });
        }

        function fillCreateSnippetDialog(payload) {
          const { selectedText, language } = payload;
          document.getElementById('snipLang').value = language || document.getElementById('languagePicker').value;
          document.getElementById('snipSubcat').value = 'custom';
          document.getElementById('snipName').value = '';
          document.getElementById('snipPrefix').value = '';
          document.getElementById('snipDesc').value = '';
          document.getElementById('snipBody').value = selectedText || '';
          createSnippetDialog.showModal();
        }

        function confirmCreateSnippet() {
          const language = document.getElementById('snipLang').value;
          const subcategory = document.getElementById('snipSubcat').value.trim() || 'custom';
          const name = document.getElementById('snipName').value.trim();
          const prefix = document.getElementById('snipPrefix').value.trim();
          const description = document.getElementById('snipDesc').value.trim();
          const body = document.getElementById('snipBody').value;

          if (!name) {
            alert('Please enter a unique Name / Key for the snippet.');
            return;
          }

          vscode.postMessage({
            command: 'createSnippet',
            data: { language, subcategory, name, prefix, description, body }
          });
        }

        function cancelCreateSnippet() {
          createSnippetDialog.close();
        }
        function updateDeleteButton() {
            const picker = document.getElementById('templatePicker');
            const btn = document.getElementById('deleteTemplateBtn');
            const val = picker.value;
            btn.disabled = (val === 'default' || val === 'Fast_IO' || val === 'Debug_Template' || val === 'CP_Template');
        }
        updateDeleteButton();

        function saveTemplate() {
            // Get which files to include
            const includeMainCpp = document.getElementById('includeMainCpp').checked;
            const includeInputTxt = document.getElementById('includeInputTxt').checked;
            const includeOutputTxt = document.getElementById('includeOutputTxt').checked;
            const templateName = document.getElementById('templateName').value.trim();

            if (!templateName) {
                alert("Please enter a template name.");
                return;
            }
            // Get content from VS Code for each file (request from extension)
            vscode.postMessage({
                command: 'saveTemplate',
                templateName,
                includeMainCpp,
                includeInputTxt,
                includeOutputTxt
            });
            dialog.close();
        }

        

        function addTemplateToPicker(name) {
            const picker = document.getElementById('templatePicker');
            if ([...picker.options].some(opt => opt.value === name)) return;
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            picker.appendChild(opt);
        }

        function removeTemplateFromPicker(name) {
            const picker = document.getElementById('templatePicker');
            for (let i = 0; i < picker.options.length; i++) {
                if (picker.options[i].value === name) {
                    picker.remove(i);
                    break;
                }
            }
            selectedTemplate = picker.value;
            updateDeleteButton();
        }

        function onSnippetLanguageSelected(event) {
            const selectedLanguage = document.getElementById('languagePicker').value;
            vscode.postMessage({
                command: 'getSnippetCategories',
                selectedLanguage
            })

        }

        function createCategoryButtons(categoryList, parentElement, type) {
            parentElement.innerHTML = ''; // clear existing
            categoryList.forEach(cat => {
                const div = document.createElement('div');

                div.className = `${type}-${cat}`;
                
                const btn = document.createElement('button');
                btn.textContent = cat;
                btn.dataset.category = type;
                btn.dataset.subcategory = cat;
                btn.className = 'accordion';
                btn.onclick = loadSnippetsFromCategory;
                
                const listdiv = document.createElement('div');
                listdiv.className = `panel ${cat}List`;
                div.appendChild(btn);
                div.appendChild(listdiv);
                parentElement.appendChild(div);
            });
        }

        function loadSnippetsFromCategory(event) {
            const category = event.target.getAttribute('data-category');
            const subCategory = event.target.getAttribute('data-subcategory');
            const language = document.getElementById('languagePicker').value;

            vscode.postMessage({
                command: 'loadSnippetsFromCategory',
                language,
                category,
                subCategory
            });
        }


        // Listen for messages from extension to update template picker
        window.addEventListener('message', event => {
            const msg = event.data;
            switch(msg.command){
                case 'updateThemeClass': {
                    const body = document.querySelector('body');
                    if (body) {
                        body.classList.remove('vscode-dark', 'vscode-light');
                        body.classList.add(msg.themeClass);
                    }
                    break;
                }
                case 'addTemplateToPicker': {
                    addTemplateToPicker(msg.templateName);
                    break;
                }
                case 'removeTemplateFromPicker': {
                    removeTemplateFromPicker(msg.templateName);
                    break;
                }
                case 'initTemplates': {
                    // Remove all except built-ins
                    const picker = document.getElementById('templatePicker');
                    for (let i = picker.options.length - 1; i >= 0; i--) {
                        if (
                            picker.options[i].value !== 'default' &&
                            picker.options[i].value !== 'Fast_IO' &&
                            picker.options[i].value !== 'Debug_Template' &&
                            picker.options[i].value !== 'CP_Template'
                        ) {
                            picker.remove(i);
                        }
                    }
                    // Add all custom templates
                    msg.templates.forEach(tpl => {
                        if (
                            tpl !== 'default' &&
                            tpl !== 'Fast_IO' &&
                            tpl !== 'Debug_Template' &&
                            tpl !== 'CP_Template'
                        ) {
                            addTemplateToPicker(tpl);
                        }
                    });
                    break;
                }
                case 'openCreateSnippetDialog': {
                  fillCreateSnippetDialog(msg);
                  break;
                }
                case 'selectionText': {
                  const area = document.getElementById('snipBody');
                  if (area) area.value = msg.selectedText || '';
                  break;
                }
                case 'snippetSaved': {
                  // Close dialog, refresh categories & UI
                  cancelCreateSnippet();
                  // Refresh categories for the language that just changed
                  vscode.postMessage({
                    command: 'getSnippetCategories',
                    selectedLanguage: msg.language
                  });
                  vscode.postMessage({
                    command: 'showToast',
                    type: 'info',
                    text: `‚úÖ Snippet '${msg.key}' saved successfully in '${msg.subcategory}'!`
                  });
                  collapseAllAccordions();
                  expandAccordionCategory(msg.subcategory);
                  break;
                }
                case 'loadSnippetCategories': {
                    // Close all open accordions before rendering new categories
                    collapseAllAccordions();

                    const { categories } = msg;
                    const dsPanel = document.querySelector('.snippetSelection .dsPanel');
                    const algoPanel = document.querySelector('.snippetSelection .algoPanel');
                    const miscPanel = document.querySelector('.snippetSelection .miscPanel');
                    const customPanel = document.querySelector('.snippetSelection .customPanel');

                    const ds = (categories && categories.dataStructures) || [];
                    const alg = (categories && categories.algorithms) || [];
                    const mis = (categories && categories.misc) || [];
                    const cus = (categories && categories.custom) || [];

                    if (dsPanel) createCategoryButtons(ds, dsPanel, 'data_structures');
                    if (algoPanel) createCategoryButtons(alg, algoPanel, 'algorithms');
                    if (miscPanel) createCategoryButtons(mis, miscPanel, 'misc');
                    if (customPanel) createCategoryButtons(cus, customPanel, 'custom');
                    break;
                }
                case 'snippetsForCategory': {
                    console.log('snippetsForCategory', msg);
                    
                    const containers = document.querySelectorAll(`.${msg.category}-${msg.subCategory} .${msg.subCategory}List`);
                    if (!containers || containers.length === 0) return;
                    containers[0].innerHTML = "";
                    Object.values(msg.snippets).forEach(snippet => {
                        const btn = document.createElement('button');
                        btn.className = 'snippetItem';
                        btn.textContent = snippet.prefix;
                        btn.title = snippet.description;

                        btn.addEventListener('mouseenter', (e) => {
                            const tooltip = document.getElementById('snippetTooltip');
                            tooltip.textContent = snippet.body.join('\n');
                            tooltip.style.display = 'block';

                            // Position after layout so we can read its size
                            requestAnimationFrame(() => {
                            const pad = 12;
                            let top = e.clientY + pad;
                            let left = pad; // start from left edge so it can extend beyond the sidebar

                            const ttWidth = tooltip.offsetWidth;
                            const ttHeight = tooltip.offsetHeight;
                            const vw = window.innerWidth;
                            const vh = window.innerHeight;

                            if (top + ttHeight > vh) {
                                top = Math.max(pad, e.clientY - ttHeight - pad);
                            }
                            if (left + ttWidth > vw) {
                                left = Math.max(pad, vw - ttWidth - pad);
                            }

                            tooltip.style.top = `${top}px`;
                            tooltip.style.left = `${left}px`;
                            });

                            const previewId = `${msg.category}:${msg.subCategory}:${snippet.prefix}`;
                            vscode.postMessage({
                            command: "previewSnippet",
                            previewId,
                            snippet: snippet.body
                            });
                        });
                        btn.addEventListener('mouseleave', () => {
                            const tooltip = document.getElementById('snippetTooltip');
                            tooltip.style.display = 'none';
                            const previewId = `${msg.category}:${msg.subCategory}:${snippet.prefix}`;
                            vscode.postMessage({
                                command: "clearPreview",
                                previewId
                            });
                        });

                        btn.addEventListener('click', () => {
                            vscode.postMessage({
                                command: 'insertSnippet',
                                snippet: snippet.body.join('\n')
                            });
                        });

                        containers[0].appendChild(btn);
                    });
                    break;
                }
            }
            

        });
    </script>
    </body>
</html>