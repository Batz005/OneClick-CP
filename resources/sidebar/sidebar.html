<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{styleUri}}" />
    <title>OneClick CP</title>
    </head>
    <body>
    <div class="sidebar-header">
        <img src="{{logoUri}}" class="logo" alt="OneClick CP Logo" />
        <h2>OneClick CP</h2>
        <p class="subtitle">Your one-click DSA & CP starter kit</p>
    </div>
    <div class="sidebar-container">
        <!-- ===================== -->
        <!-- Template Actions      -->
        <!-- ===================== -->
        <label for="templatePicker" class="template-label">Choose Template:</label>
        <div class="template-picker-row">
            <select id="templatePicker">
                <option value="default">Default Template</option>
                <option value="Fast_IO">Fast IO</option>
                <option value="Debug_Template">Debug Template</option>
                <option value="CP_Template">CP Template</option>
            </select>
            <button
                id="deleteTemplateBtn"
                title="Delete selected template(works only for custom templates)"
                class="delete-btn"
                onclick="deleteTemplate()"
                aria-label="Delete Template"
            >üóëÔ∏è</button>
        </div>
        <div class="button-row">
            <div class="feature-resetFiles">
                <button
                    title="resets files main.cpp, input.txt and output.txt based on current template selected."
                    class="reset-btn"
                    onclick="resetFiles()"
                >
                    üîÑ Reset Files
                </button>
            </div>
            <div class="feature-exportSolution">
                <button
                    title="This feature, copies the active files in editor(main.cpp, input.txt and output.txt).It exports your solution to Solutions folder with your given name"
                    onclick="vscode.postMessage({ command: 'exportSolution' })"
                >
                    üì§Export Solution
                </button>
            </div>
        </div>
        <div class="feature-resetAndExportSolution" style="margin-top: 0.5em;">
            <button
                title="Exports Current Solution and Resets files based on current template selected."
                onclick="vscode.postMessage({ command: 'resetAndExportSolution' })"
            >
                üì§Export Solution + üîÑReset Files
            </button>
        </div>
        <div class="feature-saveTemplate" style="margin-top: 0.5em;">
            <button
                title="Creates custom template from the main.cpp, input.txt and output.txt files and saves it in templates list for future purposes."
                onclick="openSaveTemplateDialog()"
            >
                Create Custom Template
            </button>
        </div>

        <!-- ===================== -->
        <!-- Snippet Section       -->
        <!-- ===================== -->
        <div class="feature-snippets" style="margin-top: 1.5em;">
            <h2>Snippets</h2>

            <!-- Snippet Preview Toggle -->
            <div style="margin-bottom: 0.5em;">
                <label>
                    <input type="checkbox" id="showPreview" checked />
                    Snippet Preview
                </label>
            </div>

            <!-- Language Selection -->
            <div style="margin-bottom: 0.5em;">
                <label for="languagePicker">Choose a language:</label>
                <select id="languagePicker" onclick="onSnippetLanguageSelected()">
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                    <option value="java">Java</option>
                </select>
            </div>

            <!-- Accordion for Snippet Categories -->
            <button class="accordion">Snippets</button>
            <div class="panel snippetSelection">
                <!-- Data Structures -->
                <div class="data_structures">
                    <button class="accordion" value="data_structures">Data Structures</button>
                    <div class="dsPanel panel"></div>
                </div>

                <!-- Algorithms -->
                <div class="algorithms">
                    <button class="accordion" value="algorithms">Algorithms</button>
                    <div class="algoPanel panel"></div>
                </div>

                <!-- Miscellaneous -->
                <div class="misc">
                    <button class="accordion" value="misc">Miscellaneous</button>
                    <div class="miscPanel panel"></div>
                </div>

                <!-- Custom -->
                <div class="custom">
                    <button class="accordion" value="custom">Custom</button>
                    <div class="customPanel panel">
                        <button value="custom" data-category="custom" data-subcategory="all" onclick="loadSnippetsFromCategory(event)">All Custom Snippets</button>
                            <div id="snippetListContainer" style="margin-top: 1em;"></div>
                    </div>
                </div>

            </div>


        </div>

        <!-- ===================== -->
        <!-- Arrange View Button   -->
        <!-- ===================== -->
        <div class="feature-arrangeView" style="margin-top: 1em;">
            <button
                title="Arranges Layout: main.cpp in left column. input.txt and output.txt in right column, top and bottom respectively."
                onclick="vscode.postMessage({ command: 'arrangeLayout' })"
            >üß©Arrange View</button>
        </div>

        <p class="coming-soon" style="margin-top: 1.5em;">üî• More features coming soon...</p>
    </div>

    <!-- Save Template Dialog -->
    <dialog id="saveTemplateDialog">
      <form method="dialog" id="saveTemplateForm">
        <h4>Create Custom Template</h4>
        <p class="dialog-info">
            Only checked files will be saved. Content is taken from open files in your workspace.
        </p>
        <div>
          <label><input type="checkbox" id="includeMainCpp" checked /> main.cpp</label><br>
          <label><input type="checkbox" id="includeInputTxt" checked /> input.txt</label><br>
          <label><input type="checkbox" id="includeOutputTxt" checked /> output.txt</label>
        </div>
        <div>
          <label for="templateName">Template Name:</label>
          <input type="text" id="templateName" required />
        </div>
        <div>
          <button type="button" onclick="saveTemplate()">Save</button>
          <button type="button" onclick="closeSaveTemplateDialog()">Cancel</button>
        </div>
      </form>
    </dialog>

    <!-- Confirm Delete Dialog -->
    <dialog id="deleteConfirmDialog">
    <form method="dialog">
        <p id="deleteConfirmText"></p>
        <button value="yes" id="deleteYesBtn">Delete</button>
        <button value="no">Cancel</button>
    </form>
    </dialog>

    <div class="signature">
        <img src="{{bkLogoUri}}" class="bk-logo" alt="Bharath Kotipalli Logo" />
        <p>Created by Bharath Kotipalli</p>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        let selectedTemplate = 'default';

        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("accordion")) {
                e.target.classList.toggle("active");
                const panel = e.target.nextElementSibling;
                if (panel && panel.classList.contains("panel")) {
                    panel.style.display = panel.style.display === "flex" ? "none" : "flex";
                }
            }
        });
        document.getElementById('templatePicker').addEventListener('change', (e) => {
            selectedTemplate = e.target.value;
            updateDeleteButton();
        });

        function deleteTemplate() {
            const picker = document.getElementById('templatePicker');
            const selectedTemplate = picker.value;
            if (
                selectedTemplate === 'default' ||
                selectedTemplate === 'Fast_IO' ||
                selectedTemplate === 'Debug_Template' ||
                selectedTemplate === 'CP_Template'
            ) {
                alert("Cannot delete default/built-in templates.");
                return;
            }
            
            // Show custom dialog
            const dialog = document.getElementById('deleteConfirmDialog');
            document.getElementById('deleteConfirmText').textContent =
                `Delete template "${selectedTemplate}"?`;
            dialog.showModal();

            dialog.addEventListener('close', function handler() {
                if (dialog.returnValue === 'yes') {
                    vscode.postMessage({
                        command: 'deleteTemplate',
                        templateName: selectedTemplate
                    });
                }
                dialog.removeEventListener('close', handler);
            });
        }

        function resetFiles() {
            vscode.postMessage({ command: 'resetFiles', template: selectedTemplate });
        }

        // Dialog logic
        const dialog = document.getElementById('saveTemplateDialog');
        function openSaveTemplateDialog() {
            dialog.showModal();
        }
        function closeSaveTemplateDialog() {
            dialog.close();
        }
        // Update delete button enable/disable state
        document.getElementById('templatePicker').addEventListener('change', updateDeleteButton);
        
        function updateDeleteButton() {
            const picker = document.getElementById('templatePicker');
            const btn = document.getElementById('deleteTemplateBtn');
            const val = picker.value;
            btn.disabled = (val === 'default' || val === 'Fast_IO' || val === 'Debug_Template' || val === 'CP_Template');
        }
        updateDeleteButton();

        function saveTemplate() {
            // Get which files to include
            const includeMainCpp = document.getElementById('includeMainCpp').checked;
            const includeInputTxt = document.getElementById('includeInputTxt').checked;
            const includeOutputTxt = document.getElementById('includeOutputTxt').checked;
            const templateName = document.getElementById('templateName').value.trim();

            if (!templateName) {
                alert("Please enter a template name.");
                return;
            }
            // Get content from VS Code for each file (request from extension)
            vscode.postMessage({
                command: 'saveTemplate',
                templateName,
                includeMainCpp,
                includeInputTxt,
                includeOutputTxt
            });
            dialog.close();
        }

        

        function addTemplateToPicker(name) {
            const picker = document.getElementById('templatePicker');
            if ([...picker.options].some(opt => opt.value === name)) return;
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            picker.appendChild(opt);
        }

        function removeTemplateFromPicker(name) {
            const picker = document.getElementById('templatePicker');
            for (let i = 0; i < picker.options.length; i++) {
                if (picker.options[i].value === name) {
                    picker.remove(i);
                    break;
                }
            }
            selectedTemplate = picker.value;
            updateDeleteButton();
        }

        function onSnippetLanguageSelected(event) {
            const selectedLanguage = document.getElementById('languagePicker').value;
            vscode.postMessage({
                command: 'getSnippetCategories',
                selectedLanguage
            })

        }

        function createCategoryButtons(categoryList, parentElement, type) {
            parentElement.innerHTML = ''; // clear existing
            categoryList.forEach(cat => {
                const div = document.createElement('div');

                div.className = `${type}-${cat}`;
                
                const btn = document.createElement('button');
                btn.textContent = cat;
                btn.dataset.category = type;
                btn.dataset.subcategory = cat;
                btn.className = 'accordion';
                btn.onclick = loadSnippetsFromCategory;
                
                const listdiv = document.createElement('div');
                listdiv.className = `panel ${cat}List`;
                div.appendChild(btn);
                div.appendChild(listdiv);
                parentElement.appendChild(div);
            });
        }

        function loadSnippetsFromCategory(event) {
            const category = event.target.getAttribute('data-category');
            const subCategory = event.target.getAttribute('data-subcategory');
            const language = document.getElementById('languagePicker').value;

            vscode.postMessage({
                command: 'loadSnippetsFromCategory',
                language,
                category,
                subCategory
            });
        }


        // Listen for messages from extension to update template picker
        window.addEventListener('message', event => {
            const msg = event.data;
            if (msg.command === 'addTemplateToPicker') {
                addTemplateToPicker(msg.templateName);
            }
            if (msg.command === 'removeTemplateFromPicker') {
                removeTemplateFromPicker(msg.templateName);
            }
            if (msg.command === 'initTemplates') {
                // Remove all except built-ins
                const picker = document.getElementById('templatePicker');
                for (let i = picker.options.length - 1; i >= 0; i--) {
                    if (
                        picker.options[i].value !== 'default' &&
                        picker.options[i].value !== 'Fast_IO' &&
                        picker.options[i].value !== 'Debug_Template' &&
                        picker.options[i].value !== 'CP_Template'
                    ) {
                        picker.remove(i);
                    }
                }
                // Add all custom templates
                msg.templates.forEach(tpl => {
                    if (
                        tpl !== 'default' &&
                        tpl !== 'Fast_IO' &&
                        tpl !== 'Debug_Template' &&
                        tpl !== 'CP_Template'
                    ) {
                        addTemplateToPicker(tpl);
                    }
                });
            }
            if (msg.command === 'loadSnippetCategories') {
                console.log('loadCategories');
                const { categories, language } = msg;
                console.log(categories);
                const dsPanel = document.querySelector('.snippetSelection .dsPanel');
                const algoPanel = document.querySelector('.snippetSelection .algoPanel');
                const miscPanel = document.querySelector('.snippetSelection .miscPanel');
                const customPanel = document.querySelector('.snippetSelection .customPanel');

                createCategoryButtons(categories.dataStructures, dsPanel, 'data_structures');
                createCategoryButtons(categories.algorithms, algoPanel, 'algorithms');
                createCategoryButtons(categories.misc, miscPanel, 'misc');
                createCategoryButtons(categories.custom, customPanel, 'custom');
            }
            if (msg.command === 'snippetsForCategory') {
                console.log('snippetsForCategory', msg);
                
                const containers = document.querySelectorAll(`.${msg.category}-${msg.subCategory} .${msg.subCategory}List`);
                if (!containers || containers.length === 0) return;
                containers[0].innerHTML = "";
                Object.values(msg.snippets).forEach(snippet => {
                    const btn = document.createElement('button');
                    btn.className = 'snippetItem';
                    btn.textContent = snippet.prefix;
                    btn.title = snippet.description;

                    btn.addEventListener('click', () => {
                        vscode.postMessage({
                            command: 'insertSnippet',
                            snippet: snippet.body.join('\n')
                        });
                    });

                    containers[0].appendChild(btn);
                });
            }

        });
    </script>
    </body>
</html>